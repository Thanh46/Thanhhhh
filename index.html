<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>SMART MODULE</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      min-height: 100vh;
      color: #e0e0e0;
      overflow-x: hidden;
    }
    h1 {
      font-size: 28px;
      color: #00d4ff;
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff;
    }
    .box {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.05);
      color: #e0e0e0;
      transition: all 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #00d4ff;
      outline: none;
      box-shadow: 0 0 10px #00d4ff;
    }
    .hidden { display: none; }
    #clock {
      text-align: center;
      font-size: 16px;
      color: #b3e5fc;
      margin-bottom: 15px;
      animation: fadeIn 2s infinite alternate;
    }
    .status {
      text-align: center;
      margin: 10px 0;
      font-size: 24px;
    }
    .wifi-led {
      width: 10px;
      height: 10px;
      background: #ff0000;
      border-radius: 50%;
      display: inline-block;
      margin-left: 10px;
      transition: background 0.5s;
    }
    .wifi-led.connected {
      background: #00ff00;
    }
    .device-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .device-group {
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
      text-align: center;
    }
    .device-group:hover {
      transform: translateY(-5px);
    }
    .device-group input {
      width: 80%;
      margin: 5px auto;
      font-size: 12px;
    }
    .device-group .button-group {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .device-group button {
      width: 40px;
      padding: 5px;
      font-size: 12px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      margin-top: 5px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: #fff;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #00ff95;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .slider:hover {
      background-color: #777;
    }
    input:checked + .slider:hover {
      background-color: #00cc76;
    }
    button {
      background: linear-gradient(45deg, #00d4ff, #007bff);
      color: white;
      border: none;
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    button:hover {
      background: linear-gradient(45deg, #00aaff, #0056b3);
      transform: scale(1.05);
    }
    #voiceResult {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #00ff95;
      animation: pulse 1.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0.7; }
      to { opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

<div id="clock"></div>
<div class="status" id="mqttStatus">‚è≥ <span class="wifi-led" id="wifiLed"></span></div>

<div class="box" id="loginBox">
  <h1>SMART MODULE</h1>
  <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
  <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
  <label><input type="checkbox" id="rememberMe"> Nh·ªõ t√†i kho·∫£n</label>
  <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
</div>

<div class="box hidden" id="controlBox">
  <h1>SMART MODULE</h1>
  <div class="status" id="mqttStatus">‚è≥ <span class="wifi-led" id="wifiLed"></span></div>
  <div class="device-grid" id="devices"></div>
  <button onclick="startVoice()">N√≥i ƒë·ªÉ ƒëi·ªÅu khi·ªÉn</button>
  <div id="voiceResult"></div>
  <button onclick="showPage('scheduleBox')">H·∫πn gi·ªù</button>
  <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
</div>

<div class="box hidden" id="scheduleBox">
  <h1>SMART MODULE - H·∫πn gi·ªù</h1>
  <select id="deviceSelector"></select>
  <label>Gi·ªù b·∫≠t:</label>
  <input type="time" id="onTime">
  <button onclick="setTime('on')">ƒê·∫∑t gi·ªù m·ªü</button> <!-- Thay "b·∫≠t" b·∫±ng "m·ªü" -->
  <button onclick="clearTime('on')">X√≥a</button>
  <div id="onTimeStatus"></div>

  <label>Gi·ªù t·∫Øt:</label>
  <input type="time" id="offTime">
  <button onclick="setTime('off')">ƒê·∫∑t gi·ªù ƒë√≥ng</button> <!-- Thay "t·∫Øt" b·∫±ng "ƒë√≥ng" -->
  <button onclick="clearTime('off')">X√≥a</button>
  <div id="offTimeStatus"></div>

  <div class="schedule-note" id="scheduleNotes">
    <strong>L·ªãch s·ª≠ h·∫πn gi·ªù:</strong><br>
    <span id="scheduleNoteContent"></span>
  </div>

  <button onclick="showPage('controlBox')">Tr·ªü v·ªÅ</button>
</div>

<script>
  const STORAGE_KEY = 'tbt_credentials';
  let client;
  let deviceNames = Array(10).fill("");
  let scheduleHistory = {};

  function showPage(id) {
    ['loginBox', 'controlBox', 'scheduleBox'].forEach(box =>
      document.getElementById(box).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleString('vi-VN');
  }
  setInterval(updateClock, 1000);
  updateClock();

  function login() {
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value;
    const remember = document.getElementById("rememberMe").checked;
    if (user === "Chu_may_001" && pass === "123456789") {
      if (remember) localStorage.setItem(STORAGE_KEY, JSON.stringify({ user, pass }));
      showPage('controlBox');
      connectMQTT();
    } else {
      alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
    }
  }

  function logout() {
    localStorage.removeItem(STORAGE_KEY);
    showPage('loginBox'); // Quay v·ªÅ giao di·ªán ƒëƒÉng nh·∫≠p
  }

  window.onload = () => {
    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (stored) {
      document.getElementById("username").value = stored.user;
      document.getElementById("password").value = stored.pass;
    }
  };

  function connectMQTT() {
    client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
    const mqttStatus = document.getElementById("mqttStatus");
    const wifiLed = document.getElementById("wifiLed");
    const devicesDiv = document.getElementById("devices");
    const deviceSelector = document.getElementById("deviceSelector");
    const scheduleNoteContent = document.getElementById("scheduleNoteContent");

    client.on('connect', () => {
      mqttStatus.textContent = "üü¢";
      wifiLed.classList.add('connected'); // B·∫≠t ƒë√®n b√°o khi k·∫øt n·ªëi th√†nh c√¥ng
      client.subscribe("esp32/requestSync");
      for (let i = 0; i < 10; i++) {
        client.subscribe("esp32/device" + i + "/status");
        client.subscribe("esp32/device" + i + "/name");
        client.subscribe("esp32/device" + i + "/setOnTime");
        client.subscribe("esp32/device" + i + "/setOffTime");
        client.publish("esp32/requestSync", "");
      }

      devicesDiv.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        const div = document.createElement("div");
        div.className = "device-group";
        div.innerHTML = `
          <input type="text" id="deviceName${i}" placeholder="Thi·∫øt b·ªã ${i + 1}" readonly>
          <div class="button-group">
            <button id="editNameBtn${i}">S·ª≠a</button>
            <button id="saveNameBtn${i}" disabled>L∆∞u</button>
          </div>
          <label>M·ªü/ƒê√≥ng:</label> <!-- Thay "B·∫≠t/T·∫Øt" b·∫±ng "M·ªü/ƒê√≥ng" -->
          <label class="switch">
            <input type="checkbox" id="toggleSwitch${i}">
            <span class="slider"></span>
          </label>
        `;
        devicesDiv.appendChild(div);

        const nameInput = document.getElementById("deviceName" + i);
        const editBtn = document.getElementById("editNameBtn" + i);
        const saveBtn = document.getElementById("saveNameBtn" + i);
        const toggleSwitch = document.getElementById("toggleSwitch" + i);

        editBtn.onclick = () => {
          nameInput.readOnly = false;
          saveBtn.disabled = false;
        };

        saveBtn.onclick = () => {
          const newName = nameInput.value.trim();
          if (newName) {
            client.publish("esp32/device" + i + "/name", newName);
            nameInput.readOnly = true;
            saveBtn.disabled = true;
            deviceNames[i] = newName;
            deviceSelector.innerHTML += `<option value="${i}">${newName}</option>`;
          }
        };

        toggleSwitch.addEventListener('change', () => {
          const msg = toggleSwitch.checked ? "m·ªü" : "ƒë√≥ng"; // Thay "b·∫≠t ƒë√®n" b·∫±ng "m·ªü", "t·∫Øt ƒë√®n" b·∫±ng "ƒë√≥ng"
          client.publish("esp32/device" + i + "/text", msg);
        });

        client.on('message', (topic, message) => {
          const msg = message.toString().trim();
          if (topic.startsWith("esp32/device" + i + "/status")) {
            toggleSwitch.checked = (msg === "on");
          } else if (topic.startsWith("esp32/device" + i + "/name")) {
            nameInput.value = msg;
            deviceNames[i] = msg;
            deviceSelector.innerHTML = '';
            for (let j = 0; j < 10; j++) {
              if (deviceNames[j]) {
                deviceSelector.innerHTML += `<option value="${j}">${deviceNames[j]}</option>`;
              }
            }
          } else if (topic.startsWith("esp32/device" + i + "/setOnTime")) {
            scheduleHistory[i] = scheduleHistory[i] || { on: [], off: [] };
            if (msg) {
              scheduleHistory[i].on.push(msg);
            } else {
              scheduleHistory[i].on = [];
            }
            updateScheduleNotes();
          } else if (topic.startsWith("esp32/device" + i + "/setOffTime")) {
            scheduleHistory[i] = scheduleHistory[i] || { on: [], off: [] };
            if (msg) {
              scheduleHistory[i].off.push(msg);
            } else {
              scheduleHistory[i].off = [];
            }
            updateScheduleNotes();
          }
        });
      }
    });

    client.on('error', () => {
      mqttStatus.textContent = "üî¥";
      wifiLed.classList.remove('connected'); // T·∫Øt ƒë√®n b√°o khi m·∫•t k·∫øt n·ªëi
    });
  }

  function setTime(type) {
    const dev = document.getElementById("deviceSelector").value;
    const val = document.getElementById(type === 'on' ? 'onTime' : 'offTime').value;
    const topic = "esp32/device" + dev + "/set" + (type === 'on' ? "OnTime" : "OffTime");
    if (val) {
      client.publish(topic, val);
      document.getElementById(type + 'TimeStatus').textContent = `Gi·ªù ${type === 'on' ? 'm·ªü' : 'ƒë√≥ng'}: ${val}`; // Thay "b·∫≠t" b·∫±ng "m·ªü", "t·∫Øt" b·∫±ng "ƒë√≥ng"
    }
  }

  function clearTime(type) {
    const dev = document.getElementById("deviceSelector").value;
    const topic = "esp32/device" + dev + "/set" + (type === 'on' ? "OnTime" : "OffTime");
    client.publish(topic, "");
    document.getElementById(type + 'TimeStatus').textContent = `ƒê√£ x√≥a gi·ªù ${type === 'on' ? 'm·ªü' : 'ƒë√≥ng'}`; // Thay "b·∫≠t" b·∫±ng "m·ªü", "t·∫Øt" b·∫±ng "ƒë√≥ng"
  }

  function updateScheduleNotes() {
    const scheduleNoteContent = document.getElementById("scheduleNoteContent");
    let notes = "";
    for (let i = 0; i < 10; i++) {
      if (deviceNames[i] && (scheduleHistory[i]?.on.length || scheduleHistory[i]?.off.length)) {
        notes += `<strong>${deviceNames[i]}:</strong><br>`;
        if (scheduleHistory[i].on.length) {
          notes += `Gi·ªù m·ªü: ${scheduleHistory[i].on.join(', ')}<br>`; // Thay "b·∫≠t" b·∫±ng "m·ªü"
        }
        if (scheduleHistory[i].off.length) {
          notes += `Gi·ªù ƒë√≥ng: ${scheduleHistory[i].off.join(', ')}<br>`; // Thay "t·∫Øt" b·∫±ng "ƒë√≥ng"
        }
        notes += "<br>";
      }
    }
    scheduleNoteContent.innerHTML = notes || "Ch∆∞a c√≥ l·ªãch s·ª≠ h·∫πn gi·ªù.";
  }

  let recognition;
  function startVoice() {
    if (!('webkitSpeechRecognition' in window)) {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API");
      return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.lang = "vi-VN";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.start();
    document.getElementById("voiceResult").textContent = "ƒêang nghe...";

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript.toLowerCase();
      document.getElementById("voiceResult").textContent = `B·∫°n n√≥i: "${transcript}"`;

      for (let i = 0; i < 10; i++) {
        if (deviceNames[i] && transcript.includes(deviceNames[i].toLowerCase())) {
          if (transcript.includes("m·ªü")) { // Thay "b·∫≠t" b·∫±ng "m·ªü"
            client.publish("esp32/device" + i + "/text", "m·ªü");
            document.getElementById("toggleSwitch" + i).checked = true;
            document.getElementById("voiceResult").textContent += " ƒê√£ m·ªü!";
            return;
          } else if (transcript.includes("ƒë√≥ng")) { // Thay "t·∫Øt" b·∫±ng "ƒë√≥ng"
            client.publish("esp32/device" + i + "/text", "ƒë√≥ng");
            document.getElementById("toggleSwitch" + i).checked = false;
            document.getElementById("voiceResult").textContent += " ƒê√£ ƒë√≥ng!";
            return;
          }
        }
      }
      document.getElementById("voiceResult").textContent += " Kh√¥ng hi·ªÉu l·ªánh!";
    };

    recognition.onerror = function() {
      document.getElementById("voiceResult").textContent = "L·ªói khi nh·∫≠n gi·ªçng n√≥i!";
    };
  }
</script>
</body>
</html>