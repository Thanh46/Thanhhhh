<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Điều khiển</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f0f0f0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #login, #control {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      gap: 15px;
      min-width: 300px;
    }
    input {
      padding: 10px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      padding: 10px;
      border: none;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .password-wrap {
      position: relative;
    }
    .toggle-password {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      cursor: pointer;
    }
    label {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="login">
  <h3>🔒 Đăng nhập</h3>
  <label>Tài khoản</label>
  <input type="text" id="username" placeholder="Tài khoản">

  <label>Mật khẩu</label>
  <div class="password-wrap">
    <input type="password" id="password" placeholder="Mật khẩu">
    <span class="toggle-password" onclick="togglePassword()">👁️</span>
  </div>

  <button onclick="checkLogin()">Đăng nhập</button>
</div>

<div id="control">
  <h3>📱 Điều khiển ESP32</h3>
  <label>Tên thiết bị:</label>
  <input id="deviceName" placeholder="Tên thiết bị ESP32">

  <button onclick="toggleLED()">Bật/Tắt đèn</button>
  <p>Trạng thái đèn: <span id="ledStatus">chưa xác định</span></p>
  <button onclick="logout()">🚪 Đăng xuất</button>
</div>

<script>
  const correctUser = "Chu_may_001";
  const correctPass = "123456789";

  const loginBox = document.getElementById("login");
  const controlBox = document.getElementById("control");
  const deviceNameInput = document.getElementById("deviceName");
  const ledStatusText = document.getElementById("ledStatus");

  const savedUser = localStorage.getItem("username");
  const savedPass = localStorage.getItem("password");

  if (savedUser === correctUser && savedPass === correctPass) {
    showControl();
  } else {
    loginBox.style.display = "flex";
  }

  function togglePassword() {
    const passInput = document.getElementById("password");
    passInput.type = passInput.type === "password" ? "text" : "password";
  }

  function checkLogin() {
    const u = document.getElementById("username").value.trim();
    const p = document.getElementById("password").value.trim();
    if (u === correctUser && p === correctPass) {
      if (confirm("Bạn có muốn lưu đăng nhập không?")) {
        localStorage.setItem("username", u);
        localStorage.setItem("password", p);
      }
      showControl();
    } else {
      alert("Sai tài khoản hoặc mật khẩu!");
    }
  }

  function logout() {
    localStorage.clear();
    location.reload();
  }

  function showControl() {
    loginBox.style.display = "none";
    controlBox.style.display = "flex";
    setupMQTT();
  }

  let client;
  let ledState = false;

  function setupMQTT() {
    client = mqtt.connect("wss://mqtt-dashboard.com:8884");

    client.on("connect", () => {
      console.log("MQTT kết nối");
      client.subscribe("esp32/status");
      client.subscribe("esp32/name");
      client.publish("esp32/requestSync", "sync");
    });

    client.on("message", (topic, message) => {
      const msg = message.toString();
      if (topic === "esp32/status") {
        ledState = msg === "on";
        ledStatusText.innerText = ledState ? "đang bật" : "đang tắt";
      }
      if (topic === "esp32/name") {
        deviceNameInput.value = msg;
      }
    });
  }

  function toggleLED() {
    const cmd = ledState ? "tắt đèn" : "bật đèn";
    client.publish("esp32/text", cmd);
  }

  function sendDeviceName() {
    const name = deviceNameInput.value.trim();
    if (name !== "") {
      client.publish("esp32/name", name);
    }
  }

  deviceNameInput.addEventListener("change", sendDeviceName);
  deviceNameInput.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      sendDeviceName();
      deviceNameInput.blur();
    }
  });
</script>

</body>
</html>
