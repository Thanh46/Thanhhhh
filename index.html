<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒêi·ªÅu khi·ªÉn ESP32</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    .box {
      background: #fff;
      padding: 20px;
      margin: 80px auto;
      width: 320px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }

    input[type="text"],
    input[type="password"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 10px auto;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .password-wrapper {
      position: relative;
      width: 100%;
      margin: 10px auto;
    }

    .password-wrapper input {
      width: calc(100% - 40px);
      padding-right: 40px;
    }

    .eye-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
    }

    button {
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #218838;
    }

    .hidden {
      display: none;
    }

    .status {
      margin: 10px;
      font-weight: bold;
    }

    .connected {
      color: green;
    }

    .disconnected {
      color: red;
    }

    .switch-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    .switch-container label {
      font-weight: bold;
    }

    input[type="checkbox"] {
      transform: scale(1.3);
    }
  </style>
</head>
<body>

  <div class="box" id="loginBox">
    <h2>ƒêƒÉng nh·∫≠p</h2>
    <input type="text" id="username" placeholder="T√†i kho·∫£n"><br>
    <div class="password-wrapper">
      <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
      <span class="eye-btn" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <label>
      <input type="checkbox" id="rememberMe"> G·ª£i √Ω t√†i kho·∫£n l·∫ßn sau
    </label><br>
    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
  </div>

  <div class="box hidden" id="controlBox">
    <h2>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h2>
    <div class="status" id="mqttStatus">‚è≥ ƒêang k·∫øt n·ªëi...</div>

    <div class="switch-container">
      <label>B·∫≠t/T·∫Øt ƒë√®n</label>
      <input type="checkbox" id="toggleSwitch">
    </div>

    <input type="text" id="deviceName" placeholder="T√™n thi·∫øt b·ªã">
  </div>

  <script>
    const STORAGE_KEY = 'tbt_credentials';

    function togglePassword() {
      const passInput = document.getElementById("password");
      passInput.type = passInput.type === "password" ? "text" : "password";
    }

    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;
      const remember = document.getElementById("rememberMe").checked;

      if (user === "Chu_may_001" && pass === "123456789") {
        if (remember) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ user, pass }));
        }
        showControlUI();
      } else {
        alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
      }
    }

    function showControlUI() {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("controlBox").classList.remove("hidden");
      connectMQTT();
    }

    window.addEventListener('load', () => {
      const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (stored) {
        document.getElementById("username").value = stored.user;
        document.getElementById("password").value = stored.pass;
      }
    });

    let client;
    function connectMQTT() {
      client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
      const switchElement = document.getElementById('toggleSwitch');
      const mqttStatus = document.getElementById('mqttStatus');
      const deviceNameInput = document.getElementById("deviceName");

      client.on('connect', function () {
        mqttStatus.textContent = 'üü¢ ƒê√£ k·∫øt n·ªëi MQTT!';
        mqttStatus.className = 'status connected';

        client.subscribe('esp32/status');
        client.subscribe('esp32/name');

        client.publish('esp32/requestSync', '');
      });

      client.on('error', function () {
        mqttStatus.textContent = 'üî¥ L·ªói k·∫øt n·ªëi MQTT!';
        mqttStatus.className = 'status disconnected';
      });

      switchElement.addEventListener('change', function () {
        const cmd = this.checked ? "b·∫≠t ƒë√®n" : "t·∫Øt ƒë√®n";
        client.publish('esp32/text', cmd);
      });

      deviceNameInput.addEventListener('change', function () {
        client.publish('esp32/name', this.value);
      });

      client.on('message', function (topic, message) {
        const msg = message.toString().trim();
        if (topic === 'esp32/status') {
          switchElement.checked = (msg === 'on');
        }
        if (topic === 'esp32/name') {
          deviceNameInput.value = msg;
        }
      });
    }
  </script>

</body>
</html>
