<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chuy·ªÉn v√† T·∫£i ·∫£nh BMP</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      background-color: #f4f4f4;
    }
    h2 {
      color: #333;
      text-align: center;
    }
    input[type="file"], button, input[type="text"] {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    #downloadLink {
      display: none;
      text-align: center;
      margin: 10px 0;
      color: #0066cc;
      text-decoration: none;
      font-weight: bold;
    }
    #downloadLink:hover {
      text-decoration: underline;
    }
    #status {
      color: green;
      text-align: center;
      margin-top: 10px;
    }
    #uploadForm {
      display: none;
    }
    canvas {
      display: none;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <h2>üñºÔ∏è Chuy·ªÉn ·∫£nh b·∫•t k·ª≥ sang BMP 24-bit (240x240)</h2>
  <input type="file" id="imageInput" accept="image/*"><br><br>
  <button onclick="convertToBMP()">Chuy·ªÉn v√† T·∫£i v·ªÅ BMP</button>
  <br><br>
  <a id="downloadLink">üì• Nh·∫•n ƒë·ªÉ t·∫£i file BMP</a>
  <br><br>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="text" id="espEndpoint" placeholder="Nh·∫≠p endpoint ESP32 (v√≠ d·ª•: http://esp32.local/upload ho·∫∑c http://192.168.1.100/upload)" required>
    <input type="file" id="bmpFile" name="file">
    <input type="submit" value="üì§ G·ª≠i l√™n ESP32">
  </form>
  <p id="status"></p>
  <canvas id="canvas" width="240" height="240"></canvas>

  <script>
    function convertToBMP() {
      const fileInput = document.getElementById('imageInput');
      const status = document.getElementById('status');
      if (!fileInput.files[0]) {
        status.textContent = "üìÇ Vui l√≤ng ch·ªçn ·∫£nh!";
        status.style.color = 'red';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.getElementById('canvas');
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, 240, 240);
          ctx.drawImage(img, 0, 0, 240, 240);

          const imageData = ctx.getImageData(0, 0, 240, 240);
          const bmp = createBMP(imageData);
          const blob = new Blob([bmp], { type: 'image/bmp' });

          // Display BMP download link
          const link = document.getElementById('downloadLink');
          link.href = URL.createObjectURL(blob);
          link.download = 'image.bmp';
          link.textContent = 'üì• Nh·∫•n ƒë·ªÉ t·∫£i file BMP';
          link.style.display = 'inline';

          // Auto-upload to ESP32
          const bmpInput = document.getElementById('bmpFile');
          const dt = new DataTransfer();
          dt.items.add(new File([blob], "image.bmp", { type: "image/bmp" }));
          bmpInput.files = dt.files;
          document.getElementById('uploadForm').style.display = 'block';
          status.textContent = '‚úÖ ƒê√£ chuy·ªÉn ƒë·ªïi ·∫£nh sang BMP!';
          status.style.color = 'green';
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    function createBMP(imageData) {
      const w = imageData.width;
      const h = imageData.height;
      const rowSize = Math.ceil(w * 3 / 4) * 4;
      const imageSize = rowSize * h;
      const fileSize = 54 + imageSize;

      const buffer = new ArrayBuffer(fileSize);
      const dataview = new DataView(buffer);
      let offset = 0;

      // BMP Header
      dataview.setUint8(offset++, 0x42); // B
      dataview.setUint8(offset++, 0x4D); // M
      dataview.setUint32(offset, fileSize, true); offset += 4;
      dataview.setUint32(offset, 0, true); offset += 4;
      dataview.setUint32(offset, 54, true); offset += 4;

      // DIB Header
      dataview.setUint32(offset, 40, true); offset += 4;
      dataview.setInt32(offset, w, true); offset += 4;
      dataview.setInt32(offset, h, true); offset += 4;
      dataview.setUint16(offset, 1, true); offset += 2;
      dataview.setUint16(offset, 24, true); offset += 2;
      dataview.setUint32(offset, 0, true); offset += 4;
      dataview.setUint32(offset, imageSize, true); offset += 4;
      dataview.setInt32(offset, 0, true); offset += 4;
      dataview.setInt32(offset, 0, true); offset += 4;
      dataview.setUint32(offset, 0, true); offset += 4;
      dataview.setUint32(offset, 0, true); offset += 4;

      // Pixel data (BGR)
      const pixels = imageData.data;
      for (let y = h - 1; y >= 0; y--) {
        let rowStart = offset;
        for (let x = 0; x < w; x++) {
          let i = (y * w + x) * 4;
          dataview.setUint8(offset++, pixels[i + 2]); // B
          dataview.setUint8(offset++, pixels[i + 1]); // G
          dataview.setUint8(offset++, pixels[i]);     // R
        }
        while ((offset - rowStart) % 4 !== 0) dataview.setUint8(offset++, 0);
      }
      return buffer;
    }

    // Handle form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const status = document.getElementById('status');
      const espEndpoint = document.getElementById('espEndpoint').value.trim();
      if (!espEndpoint) {
        status.textContent = "üì° Vui l√≤ng nh·∫≠p endpoint ESP32!";
        status.style.color = 'red';
        return;
      }

      const formData = new FormData(form);
      fetch(espEndpoint, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          status.textContent = '‚úÖ ƒê√£ g·ª≠i ·∫£nh l√™n ESP32!';
          status.style.color = 'green';
        } else {
          status.textContent = '‚ùå L·ªói khi g·ª≠i ·∫£nh: ' + response.statusText;
          status.style.color = 'red';
        }
      })
      .catch(error => {
        status.textContent = '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message;
        status.style.color = 'red';
      });
    });
  </script>
</body>
</html>