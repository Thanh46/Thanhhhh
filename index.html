<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>C√¥ng t·∫Øc th√¥ng minh TBT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      text-align: center;
      padding: 30px;
    }
    .hidden { display: none; }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 8px;
      border-radius: 4px;
    }
    #password-container {
      position: relative;
      display: inline-block;
    }
    #togglePassword {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px; width: 26px;
      left: 4px; bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #4CAF50;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: gray;
    }
    .status.connected { color: green; }
  </style>
</head>
<body>

  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="loginForm">
    <h2>ƒêƒÉng nh·∫≠p</h2>
    <input id="username" placeholder="T√†i kho·∫£n"><br>
    <div id="password-container">
      <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
      <span id="togglePassword">üëÅÔ∏è</span>
    </div><br>
    <button onclick="checkLogin()">ƒêƒÉng nh·∫≠p</button>
  </div>

  <!-- Giao di·ªán ch√≠nh -->
  <div id="mainUI" class="hidden">
    <h2>C√¥ng t·∫Øc th√¥ng minh TBT</h2>
    <input id="deviceName" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã..." onchange="updateDeviceName()"><br><br>

    <label class="switch">
      <input type="checkbox" id="toggleSwitch" onchange="toggleLED()">
      <span class="slider"></span>
    </label>

    <div class="status" id="statusText">üîå ƒêang k·∫øt n·ªëi MQTT...</div>
  </div>

  <script>
    // Login
    function checkLogin() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (user === "Chu_may_001" && pass === "123456789") {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("mainUI").classList.remove("hidden");
        client.publish("esp32/text", "get status"); // y√™u c·∫ßu ESP g·ª≠i tr·∫°ng th√°i
        let savedName = localStorage.getItem("deviceName");
        if (savedName) document.getElementById("deviceName").value = savedName;
      } else {
        alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
      }
    }

    // Hi·ªán/·∫©n m·∫≠t kh·∫©u
    document.getElementById("togglePassword").onclick = () => {
      const pass = document.getElementById("password");
      pass.type = pass.type === "password" ? "text" : "password";
    }

    // MQTT
    const client = mqtt.connect("wss://mqtt-dashboard.com:8884/mqtt");
    const statusText = document.getElementById("statusText");
    const toggle = document.getElementById("toggleSwitch");

    client.on("connect", () => {
      statusText.innerHTML = "‚úÖ ƒê√£ k·∫øt n·ªëi MQTT";
      statusText.classList.add("connected");
      client.subscribe("esp32/status");
    });

    client.on("message", (topic, message) => {
      if (topic === "esp32/status") {
        const msg = message.toString();
        if (msg === "on") toggle.checked = true;
        else if (msg === "off") toggle.checked = false;
      }
    });

    function toggleLED() {
      const state = toggle.checked ? "b·∫≠t ƒë√®n" : "t·∫Øt ƒë√®n";
      client.publish("esp32/text", state);
    }

    function updateDeviceName() {
      const name = document.getElementById("deviceName").value;
      localStorage.setItem("deviceName", name);
    }
  </script>
</body>
</html>
